# ESP32 Robot Integration for Home Assistant

Эта интеграция позволяет мониторить статус ESP32-роботов в вашей системе Home Assistant и отображать информацию на панели Lovelace.

## Возможности

- Мониторинг статуса робота в реальном времени (онлайн/оффлайн)
- Отображение информации о стриминге и FPS
- Пользовательская карточка Lovelace для удобного отображения
- Настраиваемый интервал обновления данных

## Установка

1. Скопируйте папку `esp32_robot` в директорию `custom_components` вашего Home Assistant.
2. Перезапустите Home Assistant.
3. Добавьте интеграцию через UI (Настройки > Интеграции > Добавить интеграцию).

## Настройка

1. Введите IP-адрес вашего ESP32-робота
2. Опционально установите пользовательское имя для робота
3. Опционально настройте интервал обновления статуса (в секундах)

## Информация о сенсоре

Интеграция создаёт сенсор со следующими атрибутами:

- **Состояние**: Показывает, находится ли робот в состоянии "online" или "offline"
- **Атрибуты**:
  - `ip_address`: IP-адрес робота
  - `direct_url`: Прямой URL для доступа к интерфейсу робота
  - `fps`: Текущий FPS камеры (если робот онлайн и стримит)
  - `streaming`: Статус стриминга (если робот онлайн)
  - `last_error`: Информация о последней ошибке (только если робот онлайн)

## Карточка Lovelace

Интеграция включает пользовательскую карточку Lovelace для отображения статуса робота.

### Автоматическая установка

После установки и настройки интеграции, карточка будет автоматически зарегистрирована в Home Assistant и доступна для добавления на панель Lovelace.

### Добавление карточки на панель

1. Перейдите на панель Lovelace
2. Нажмите кнопку редактирования (три точки в правом верхнем углу)
3. Выберите "Добавить карточку"
4. Найдите "ESP32 Robot Card" в списке или выберите "Пользовательская" и введите следующую конфигурацию:

```yaml
type: 'custom:esp32-robot-card'
entity: sensor.esp32_robot_status
title: 'Мой робот'
```

### Внешний вид карточки

Карточка показывает:
- Статус робота (онлайн/оффлайн) с соответствующей иконкой
- IP-адрес робота (если онлайн)
- Статус стриминга (если робот онлайн)
- FPS видеопотока (если робот онлайн и стримит)

Для улучшения пользовательского опыта, ошибки подключения не отображаются, когда робот оффлайн, чтобы не загромождать интерфейс технической информацией.

## Техническая информация

### API робота

Интеграция периодически запрашивает эндпоинт `/status` на вашем ESP32-роботе. Этот эндпоинт должен возвращать JSON-ответ примерно такого формата:

```json
{
  "streaming": true,
  "fps": 25
}
```

### Обработка ошибок

- Таймауты соединения и ошибки сети интерпретируются как статус "offline"
- Невалидный JSON считается как статус "offline"
- Ошибки HTTP считаются как статус "offline"
- Информация об ошибках сохраняется, но отображается только когда робот онлайн

## Решение проблем

Если у вас возникли проблемы с интеграцией:

1. Убедитесь, что робот включен и подключен к вашей сети
2. Проверьте, что IP-адрес указан правильно
3. Проверьте логи Home Assistant на наличие ошибок
4. Попробуйте увеличить интервал сканирования, если робот не успевает отвечать
5. Убедитесь, что эндпоинт `/status` на роботе работает корректно

## Совместимость

- Требуется Home Assistant 2023.3.0 или новее
- Робот должен иметь эндпоинт `/status`, возвращающий JSON-данные
- Поддерживаются все темы Home Assistant
- Корректно работает в мобильном приложении 

## Технические детали

Детали реализации описаны в [architecture.md](architecture.md).