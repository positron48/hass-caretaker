<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ESP32-CAM Control Interface</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --danger-color: #f44336;
            --control-bg: rgba(0, 0, 0, 0.5);
            --text-color: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: none !important;
            -ms-touch-action: none !important;
        }

        body { 
            font-family: Arial, sans-serif;
            background-color: #000;
            min-height: 100vh;
            overflow: hidden;
            color: var(--text-color);
            touch-action: none !important;
            -ms-touch-action: none !important;
            overscroll-behavior: none !important;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #000;
        }

        .stream-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2em;
        }

        #stream {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .controls-overlay {
            position: absolute;
            z-index: 2;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .controls-top {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            pointer-events: all;
            background: var(--control-bg);
            padding: 8px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .controls-right {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: all;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .control-mode-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            pointer-events: all;
            background: var(--control-bg);
            padding: 8px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            display: flex;
            gap: 10px;
        }

        .joystick-container {
            width: 200px;
            height: 200px;
            background: var(--control-bg);
            border-radius: 8px;
            padding: 20px;
            backdrop-filter: blur(5px);
            display: none;
        }

        .joystick-container.active {
            display: block;
        }

        #joystick {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }

        #stick {
            width: 40%;
            height: 40%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        .stream-status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }

        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 40px;
            text-align: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button:active {
            background: rgba(255, 255, 255, 0.3);
            opacity: 1;
        }

        .button.active {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1;
        }

        .status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            z-index: 100;
            background: var(--control-bg);
            backdrop-filter: blur(5px);
            pointer-events: all;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.8);
        }

        .status.success {
            background: rgba(76, 175, 80, 0.8);
        }

        .icon-button {
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            min-width: 44px;
            min-height: 44px;
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="video-container">
            <div class="stream-placeholder" id="stream-placeholder">
                Loading...
            </div>
            <img id="stream">
        </div>
        
        <div class="controls-overlay">
            <div class="controls-top">
                <button class="button icon-button" id="stream-toggle" title="Start/Stop Stream">
                    <span class="material-icons">play_arrow</span>
                </button>
            </div>

            <div class="control-mode-switch">
                <button class="button icon-button" id="fullscreen-button" title="Fullscreen">
                    <span class="material-icons">fullscreen</span>
                </button>
            </div>
            
            <div class="controls-right">
                <div class="joystick-container active" id="joystick-control">
                    <div id="joystick">
                        <div id="stick"></div>
                    </div>
                </div>
            </div>

            <div id="status" class="status"></div>
        </div>
    </div>

    <!-- Stream status display -->
    <div class="stream-status" id="stream-status" style="display: none;">Initializing...</div>

    <script>
        // Get entity_id from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const entityId = urlParams.get('entity_id');
        const streamImg = document.getElementById('stream');
        const streamPlaceholder = document.getElementById('stream-placeholder');
        const streamToggle = document.getElementById('stream-toggle');
        const statusDiv = document.getElementById('status');
        const streamStatusDiv = document.getElementById('stream-status');
        const joystickControl = document.getElementById('joystick-control');
        const joystick = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        const fullscreenButton = document.getElementById('fullscreen-button');
        
        // Base URL for API calls to Home Assistant
        const apiBase = `/api/esp32_robot/proxy/${entityId}`;
        
        // Variables for joystick control
        let isStreaming = false;
        let isDragging = false;
        let currentX = 0;
        let currentY = 0;
        let lastJoystickSendTime = 0;
        let pendingJoystickSend = null;
        const THROTTLE_MS = 200;
        
        // Initialize the interface
        init();
        
        function init() {
            // Start stream immediately
            startStream();
            
            // Setup status polling
            startStatusUpdates();
            
            // Setup joystick controls
            initJoystick();
            
            // Setup other control event listeners
            streamToggle.addEventListener('click', toggleStream);
            fullscreenButton.addEventListener('click', toggleFullscreen);
        }
        
        function startStream() {
            streamImg.src = `${apiBase}/stream`;
            streamImg.style.display = 'block';
            streamPlaceholder.style.display = 'none';
            streamToggle.innerHTML = '<span class="material-icons">stop</span>';
            streamToggle.classList.add('active');
            isStreaming = true;
            
            showStatus('Starting stream...');
            
            streamImg.onerror = function() {
                console.error('Failed to start stream');
                streamImg.style.display = 'none';
                streamPlaceholder.style.display = 'flex';
                streamPlaceholder.textContent = 'Stream error. Please try again.';
                streamToggle.innerHTML = '<span class="material-icons">play_arrow</span>';
                streamToggle.classList.remove('active');
                isStreaming = false;
            };
        }
        
        function stopStream() {
            fetch(`${apiBase}/stopstream`)
                .then(() => {
                    streamImg.style.display = 'none';
                    streamImg.src = '';
                    streamPlaceholder.style.display = 'flex';
                    streamToggle.innerHTML = '<span class="material-icons">play_arrow</span>';
                    streamToggle.classList.remove('active');
                    isStreaming = false;
                    showStatus('Stream stopped');
                })
                .catch(error => {
                    showStatus('Failed to stop stream: ' + error, true);
                });
        }
        
        function toggleStream() {
            if (isStreaming) {
                stopStream();
            } else {
                startStream();
            }
        }
        
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status ' + (isError ? 'error' : 'success');
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function initJoystick() {
            // Mouse events for joystick
            stick.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = true;
            });
            
            document.addEventListener('mousemove', (e) => {
                e.preventDefault();
                handleJoystickMove(e);
            });
            
            document.addEventListener('mouseup', (e) => {
                e.preventDefault();
                resetJoystick(true);
            });

            // Touch events for joystick
            stick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                handleJoystickMove(e.touches[0]);
            }, { passive: false });
            
            document.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isDragging && e.touches.length > 0) {
                    handleJoystickMove(e.touches[0]);
                }
            }, { passive: false });
            
            document.addEventListener('touchend', (e) => {
                e.preventDefault();
                resetJoystick(true);
            }, { passive: false });

            document.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                resetJoystick(true);
            }, { passive: false });
        }
        
        function handleJoystickMove(event) {
            if (!isDragging) return;

            const rect = joystick.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            // Get touch or mouse position
            const clientX = event.clientX || event.touches[0].clientX;
            const clientY = event.clientY || event.touches[0].clientY;

            // Calculate relative position from center
            let x = clientX - rect.left - centerX;
            let y = clientY - rect.top - centerY;

            // Limit to square boundary
            const maxOffset = rect.width / 2 - stick.offsetWidth / 2;
            x = Math.max(-maxOffset, Math.min(maxOffset, x));
            y = Math.max(-maxOffset, Math.min(maxOffset, y));

            // Update stick position
            stick.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

            // Calculate normalized values (-1 to 1)
            const normalizedX = x / maxOffset;
            const normalizedY = -y / maxOffset; // Invert Y for traditional control scheme

            // Only send if values changed significantly
            if (Math.abs(normalizedX - currentX) > 0.1 || Math.abs(normalizedY - currentY) > 0.1) {
                currentX = normalizedX;
                currentY = normalizedY;
                sendJoystickData(normalizedX, normalizedY);
            }
        }
        
        function resetJoystick(sendData = false) {
            isDragging = false;
            stick.style.transform = 'translate(-50%, -50%)';
            currentX = 0;
            currentY = 0;
            // Send data only if explicitly requested
            if (sendData) {
                sendJoystickData(0, 0, true);
            }
        }
        
        function sendJoystickData(x, y, force = false) {
            const now = Date.now();
            
            // Clear any pending timeout
            if (pendingJoystickSend) {
                clearTimeout(pendingJoystickSend.timeout);
            }

            // If forced or enough time has passed, send immediately
            if (force || now - lastJoystickSendTime >= THROTTLE_MS) {
                fetch(`${apiBase}/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        mode: 'joystick',
                        x: x,
                        y: y
                    })
                }).catch(error => {
                    console.error('Failed to send control data:', error);
                });
                lastJoystickSendTime = now;
                pendingJoystickSend = null;
            } else {
                // Schedule to send at next available time
                pendingJoystickSend = {
                    data: { x, y },
                    timeout: setTimeout(() => {
                        sendJoystickData(x, y, true);
                    }, THROTTLE_MS - (now - lastJoystickSendTime))
                };
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showStatus('Error attempting to enable fullscreen: ' + err.message, true);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        function startStatusUpdates() {
            // Poll status every 2 seconds
            setInterval(fetchStreamStatus, 2000);
        }
        
        function fetchStreamStatus() {
            fetch(`${apiBase}/status`)
                .then(response => response.json())
                .then(data => {
                    if (data.streaming) {
                        streamStatusDiv.textContent = `FPS: ${data.fps.toFixed(1)}`;
                        streamStatusDiv.style.display = 'block';
                    } else {
                        streamStatusDiv.textContent = 'Stream inactive';
                        streamStatusDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch stream status:', error);
                    streamStatusDiv.style.display = 'none';
                });
        }
        
        // Prevent page scrolling/zooming on mobile
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('gesturechange', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('gestureend', (e) => {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html> 