# Архитектура ESP32 Robot для Home Assistant

## Общее описание

ESP32 Robot - это компонент для Home Assistant, который позволяет мониторить статус ESP32-роботов и управлять ими через пользовательский интерфейс Lovelace. Компонент предоставляет бесшовную интеграцию между роботом и системой Home Assistant, обеспечивая защищенный доступ с авторизацией и нативный пользовательский интерфейс.

## Структура файлов

### Основные файлы

#### `custom_components/esp32_robot/__init__.py`
- Точка входа компонента
- Инициализация компонента и frontend
- Регистрация сенсоров
- Управление жизненным циклом компонента
- **Проксирование API запросов** через класс `ESP32RobotProxyView`, который перенаправляет запросы к роботу через Home Assistant
- Обработка авторизации запросов с помощью встроенных механизмов Home Assistant
- Надежное определение сущностей через entity registry и состояние

#### `custom_components/esp32_robot/manifest.json`
- Метаданные компонента
- Зависимости
- Версия
- Требования к системе

#### `custom_components/esp32_robot/config_flow.py`
- Конфигурация компонента через UI Home Assistant
- Валидация введенных данных (IP-адрес, интервал обновления)
- Создание и обновление конфигурации
- Тестирование соединения с роботом при настройке

#### `custom_components/esp32_robot/const.py`
- Константы компонента
- Настройки по умолчанию
- Схемы валидации

### Сенсоры

#### `custom_components/esp32_robot/sensor.py`
- Реализация сенсоров для мониторинга состояния робота
- Запрос `/status` на роботе для проверки его состояния
- Сбор метрик (fps, streaming)
- Обновление данных через `ESP32RobotDataCoordinator`
- Интеллектуальная обработка ошибок и таймаутов
- Атрибуты сенсора, используемые Lovelace картой и прокси-представлением

### Lovelace UI

#### `custom_components/esp32_robot/frontend.py`
- Регистрация ресурсов JavaScript для Lovelace
- Асинхронная регистрация статических путей
- Предотвращение блокирующих I/O операций в event loop
- Автоматическое добавление в интерфейс Home Assistant через `add_extra_js_url`

#### `custom_components/esp32_robot/lovelace/esp32-robot-card.js`
- Пользовательский интерфейс для Lovelace на основе LitElement
- Отображение статуса робота (онлайн/оффлайн)
- Отображение информации о стриминге и FPS
- Кнопка открытия интерфейса управления
- Нативный попап для управления роботом с джойстиком и стримингом
- Использование встроенных методов Home Assistant для аутентификации (`fetchWithAuth`)
- Адаптивный дизайн, соответствующий стилю Home Assistant
- Поддержка светлой и темной тем

#### `custom_components/esp32_robot/lovelace/editor.js`
- Конфигуратор карточки для Lovelace на основе LitElement
- Выбор сенсора для отображения из списка доступных
- Настройка заголовка карточки
- Автоматический выбор первой доступной сущности

## Взаимодействие компонентов

1. **Инициализация**:
   - Home Assistant загружает компонент через `custom_components/esp32_robot/__init__.py`
   - Регистрируются необходимые сенсоры и API endpoints
   - Настраивается frontend для Lovelace через `async_setup_frontend`
   - Регистрируется прокси-представление для API в `ESP32RobotProxyView`

2. **Конфигурация**:
   - Пользователь настраивает компонент через UI Home Assistant
   - `custom_components/esp32_robot/config_flow.py` валидирует и сохраняет настройки
   - Проверяется доступность робота по указанному IP
   - Создается запись конфигурации с уникальным ID

3. **Мониторинг**:
   - `ESP32RobotDataCoordinator` периодически (согласно заданному интервалу) запрашивает эндпоинт `/status` на роботе
   - Данные о статусе, FPS и стриминге передаются в Home Assistant
   - Обработка ошибок соединения, таймаутов и невалидных JSON-ответов
   - Определение статуса робота как "online" или "offline"

4. **Пользовательский интерфейс**:
   - Lovelace карточка `ESP32RobotCard` отображает статус робота, IP адрес и метрики
   - Кнопка "Control Interface" открывает нативный попап для управления
   - Попап содержит видеопоток с камеры робота, джойстик управления и статус
   - Все запросы управления проходят через прокси API в Home Assistant с авторизацией

5. **Проксирование запросов**:
   - Все API-запросы к роботу проходят через `ESP32RobotProxyView`
   - Запросы аутентифицируются через встроенную систему Home Assistant
   - Проверка состояния робота и получение IP-адреса из атрибутов состояния
   - Прокси поддерживает GET и POST методы
   - Обработка ошибок соединения и таймаутов

## Детали API и прокси

### API Endpoints

1. **Proxy API endpoints**:
   - `/api/esp32_robot/proxy/{sensor_id}/{path:.*}` - основной эндпоинт прокси
   - `sensor_id` - идентификатор сенсора (обычно имя робота)
   - `path` - путь запроса, который будет перенаправлен на робота

2. **Основные запросы к роботу**:
   - `/status` - получение статуса робота (JSON с fps, streaming)
   - `/stream` - получение видеопотока с камеры
   - `/control` - управление движением робота (параметры x, y от -100 до 100)

### Проксирование

1. **Аутентификация**:
   - Запросы к прокси-API требуют аутентификации в Home Assistant (`requires_auth = True`)
   - Фронтенд использует `this._hass.fetchWithAuth()` для автоматической аутентификации
   - Для изображений и потоков данных используется blob URL и Object URL API
   - Прокси удаляет заголовки Host и Authorization перед отправкой на робота

2. **Поиск сущностей и доступ к ним**:
   - Использование entity registry для надежного поиска сущностей
   - Получение IP-адреса из атрибутов состояния сущности
   - Проверка состояния робота (online/offline) перед отправкой запросов
   - Надежная обработка ошибок и логирование

3. **Обработка запросов**:
   - GET-запросы передаются напрямую с сохранением query-параметров
   - POST-запросы с телом передаются с сохранением тела и контент-типа
   - Ответы от робота возвращаются клиенту с учетом типа контента
   - Отдельная обработка потоковых данных и изображений

4. **Обработка ошибок**:
   - Таймауты запросов обрабатываются и возвращают 504 Gateway Timeout
   - Ошибки соединения возвращают 502 Bad Gateway
   - Ошибки доступа к сущностям возвращают 404 Not Found
   - Детальное логирование для диагностики проблем

## Пользовательский интерфейс

### Lovelace карточка

1. **Статическое отображение**:
   - Статус онлайн/оффлайн с цветовой индикацией
   - IP-адрес робота
   - FPS и статус стриминга (только если робот онлайн)
   - Кнопка управления (активна только если робот онлайн)

2. **Реализация с LitElement**:
   - Использует стандартные компоненты Home Assistant (ha-card, mwc-button)
   - Стили соответствуют теме Home Assistant с использованием CSS-переменных
   - Реактивное обновление при изменении состояния сенсора

### Интерфейс управления

1. **Нативный попап**:
   - Создается с помощью HTML5 Dialog API
   - Современный адаптивный дизайн с использованием CSS Grid и Flexbox
   - Соответствует дизайну Home Assistant (использует CSS-переменные)
   - Поддержка темной и светлой тем
   - Фиксированная шапка с заголовком и кнопкой закрытия
   - Полностью интегрирован в Home Assistant без использования iframe
   - Поддерживает полноэкранный режим

2. **Видеопоток**:
   - Отображается с помощью элемента `<img>` с динамическим обновлением
   - Использует Blob API и createObjectURL для работы с потоковыми данными
   - Запрос проходит через прокси-API с использованием fetchWithAuth для авторизации
   - Отображение статуса загрузки и ошибок

3. **Джойстик управления**:
   - Интерактивный элемент для управления движением
   - Поддержка как мыши, так и сенсорного экрана
   - Нормализация координат в диапазон -100 до 100
   - Отправка команд управления через прокси-API c авторизацией
   - Визуальная обратная связь при перемещении

4. **Обновление статуса**:
   - Периодический опрос эндпоинта `/status` через прокси с авторизацией
   - Отображение актуального FPS и статуса стриминга
   - Обработка ошибок соединения и автоматическая реконнект
   - Интервальные обновления для актуальности данных

## Безопасность

1. **Аутентификация**:
   - Все запросы к роботу проходят через Home Assistant и требуют авторизации
   - Используется встроенная система аутентификации Home Assistant
   - Фронтенд использует `fetchWithAuth()` для надежной авторизации
   - Прямой доступ к роботу из внешней сети не требуется

2. **Изоляция данных**:
   - Компонент не хранит чувствительных данных
   - IP-адрес хранится локально в конфигурации Home Assistant
   - Токены доступа не передаются роботу

3. **Валидация**:
   - Все входные данные проверяются
   - Используются схемы валидации (voluptuous)
   - Защита от инъекций в API-запросах
   - Санитизация параметров запросов

## Производительность

1. **Асинхронные операции**:
   - Все HTTP-запросы выполняются асинхронно
   - Статические ресурсы регистрируются через асинхронные методы
   - Избегаем блокирующих I/O операций в event loop
   - Обработка запросов с таймаутами

2. **Оптимизация Lovelace**:
   - Компактный JavaScript-код
   - Эффективное обновление UI через LitElement
   - Минимальная нагрузка на браузер
   - Ленивая загрузка видеопотока

3. **Оптимизация видеопотока**:
   - Использование Blob API и Object URL для оптимизации потока
   - Обработка ошибок загрузки изображений
   - Возможность остановки/запуска потока для экономии ресурсов
   - Контроль частоты обновления статусов

## Расширяемость

1. **Модульная структура**:
   - Каждый компонент независим
   - Отделение UI от логики
   - Легко добавлять новые функции
   - Простое тестирование

2. **Конфигурация**:
   - Гибкие настройки через config flow
   - Поддержка разных роботов
   - Настраиваемый интервал обновления
   - Расширяемый формат данных

## Последовательность работы

1. **Установка и настройка**:
   - Добавление компонента в custom_components 
   - Настройка через UI с указанием IP адреса робота
   - Регистрация JS ресурсов для Lovelace
   - Создание сущностей-сенсоров

2. **Добавление карточки**:
   - Добавление ESP32 Robot Card на Lovelace dashboard
   - Автоматический выбор доступного сенсора
   - Отображение состояния робота и метрик

3. **Использование**:
   - Мониторинг статуса через карточку
   - Открытие интерфейса управления через кнопку
   - Управление роботом через джойстик
   - Просмотр видеопотока с авторизованным доступом

## Взаимодействие с роботом

1. **HTTP API робота**:
   - Робот предоставляет свой HTTP API на порту 80
   - Основные эндпоинты: `/status`, `/stream`, `/control`
   - JSON-формат для обмена данными
   - Поддержка потоковой передачи изображений

2. **Проксирование через Home Assistant**:
   - Все запросы к роботу проходят через прокси компонента
   - Прокси обеспечивает аутентификацию и безопасность через встроенные механизмы HA
   - Надежное определение сущностей и их состояний
   - Поддержка всех методов HTTP (GET, POST)
   - Прямые эндпоинты: `/api/esp32_robot/proxy/{sensor_id}/{path}`