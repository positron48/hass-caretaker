# Архитектура ESP32 Robot для Home Assistant

## Общее описание

ESP32 Robot - это компонент для Home Assistant, который позволяет мониторить статус ESP32-роботов и управлять ими через пользовательский интерфейс Lovelace. Компонент предоставляет бесшовную интеграцию между роботом и системой Home Assistant, обеспечивая защищенный доступ с авторизацией и нативный пользовательский интерфейс.

## Структура файлов

### Основные файлы

#### `custom_components/esp32_robot/__init__.py`
- Точка входа компонента
- Инициализация компонента и frontend
- Регистрация сенсоров
- Управление жизненным циклом компонента
- **Проксирование API запросов** через класс `ESP32RobotProxyView`, который перенаправляет запросы к роботу через Home Assistant
- Обработка авторизации запросов с помощью встроенных механизмов Home Assistant
- Надежное определение сущностей через entity registry и состояние
- Поддержка CORS и CSRF-защиты для API-запросов
- Обработка всех типов HTTP-запросов (GET, POST) с сохранением заголовков

#### `custom_components/esp32_robot/manifest.json`
- Метаданные компонента
- Зависимости
- Версия
- Требования к системе

#### `custom_components/esp32_robot/config_flow.py`
- Конфигурация компонента через UI Home Assistant
- Валидация введенных данных (IP-адрес, интервал обновления)
- Создание и обновление конфигурации
- Тестирование соединения с роботом при настройке

#### `custom_components/esp32_robot/const.py`
- Константы компонента
- Настройки по умолчанию
- Схемы валидации

### Сенсоры

#### `custom_components/esp32_robot/sensor.py`
- Реализация сенсоров для мониторинга состояния робота
- Запрос `/status` на роботе для проверки его состояния
- Сбор метрик (fps, streaming)
- Обновление данных через `ESP32RobotDataCoordinator`
- Интеллектуальная обработка ошибок и таймаутов
- Атрибуты сенсора, используемые Lovelace картой и прокси-представлением

### Lovelace UI

#### `custom_components/esp32_robot/frontend.py`
- Регистрация ресурсов JavaScript для Lovelace
- Асинхронная регистрация статических путей
- Предотвращение блокирующих I/O операций в event loop
- Автоматическое добавление в интерфейс Home Assistant через `add_extra_js_url`

#### `custom_components/esp32_robot/lovelace/esp32-robot-card.js`
- Пользовательский интерфейс для Lovelace на основе LitElement
- Отображение статуса робота (онлайн/оффлайн)
- Отображение информации о стриминге и FPS
- Кнопка открытия интерфейса управления с иконкой джойстика
- Нативный попап для управления роботом с джойстиком и стримингом
- Использование встроенных методов Home Assistant для аутентификации (`fetchWithAuth`)
- Адаптивный дизайн, соответствующий стилю Home Assistant
- Поддержка светлой и темной тем
- Панель настроек камеры и LED-подсветки
- Отображение FPS с одним знаком после запятой

#### `custom_components/esp32_robot/lovelace/editor.js`
- Конфигуратор карточки для Lovelace на основе LitElement
- Выбор сенсора для отображения из списка доступных
- Настройка заголовка карточки
- Автоматический выбор первой доступной сущности

## Взаимодействие компонентов

1. **Инициализация**:
   - Home Assistant загружает компонент через `custom_components/esp32_robot/__init__.py`
   - Регистрируются необходимые сенсоры и API endpoints
   - Настраивается frontend для Lovelace через `async_setup_frontend`
   - Регистрируется прокси-представление для API в `ESP32RobotProxyView`

2. **Конфигурация**:
   - Пользователь настраивает компонент через UI Home Assistant
   - `custom_components/esp32_robot/config_flow.py` валидирует и сохраняет настройки
   - Проверяется доступность робота по указанному IP
   - Создается запись конфигурации с уникальным ID

3. **Мониторинг**:
   - `ESP32RobotDataCoordinator` периодически (согласно заданному интервалу) запрашивает эндпоинт `/status` на роботе
   - Данные о статусе, FPS и стриминге передаются в Home Assistant
   - Обработка ошибок соединения, таймаутов и невалидных JSON-ответов
   - Определение статуса робота как "online" или "offline"

4. **Пользовательский интерфейс**:
   - Lovelace карточка `ESP32RobotCard` отображает статус робота, IP адрес и метрики
   - Кнопка "Control Interface" открывает нативный попап для управления
   - Попап содержит видеопоток с камеры робота, джойстик управления и статус
   - Все запросы управления проходят через прокси API в Home Assistant с авторизацией

5. **Проксирование запросов**:
   - Все API-запросы к роботу проходят через `ESP32RobotProxyView`
   - Запросы аутентифицируются через встроенную систему Home Assistant
   - Проверка состояния робота и получение IP-адреса из атрибутов состояния
   - Прокси поддерживает GET и POST методы
   - Обработка ошибок соединения и таймаутов
   - Копирование всех оригинальных заголовков запроса, кроме 'host' и 'authorization'

## Детали API и прокси

### API Endpoints

1. **Proxy API endpoints**:
   - `/api/esp32_robot/proxy/{sensor_id}/{path:.*}` - основной эндпоинт прокси
   - `sensor_id` - идентификатор сенсора (обычно имя робота)
   - `path` - путь запроса, который будет перенаправлен на робота

2. **Основные запросы к роботу**:
   - `/status` - получение статуса робота (JSON с fps, streaming)
   - `/stream` - получение видеопотока с камеры
   - `/control` - управление движением робота (параметры x, y от -1 до 1 с плавающей точкой)
   - `/quality` - изменение настроек качества изображения (параметры resolution, quality)
   - `/led` - управление LED-подсветкой (параметр brightness от 0 до 100)
   - `/camera/settings` - получение текущих настроек камеры и LED

### Проксирование

1. **Аутентификация**:
   - Запросы к прокси-API требуют аутентификации в Home Assistant (`requires_auth = True`)
   - Фронтенд использует `this._hass.fetchWithAuth()` для автоматической аутентификации
   - Для изображений и потоков данных используется blob URL и Object URL API
   - Прокси удаляет заголовки Host и Authorization перед отправкой на робота

2. **Поиск сущностей и доступ к ним**:
   - Использование entity registry для надежного поиска сущностей
   - Получение IP-адреса из атрибутов состояния сущности
   - Проверка состояния робота (online/offline) перед отправкой запросов
   - Надежная обработка ошибок и логирование

3. **Обработка запросов**:
   - GET-запросы передаются напрямую с сохранением query-параметров
   - POST-запросы с телом передаются с сохранением тела и контент-типа
   - Ответы от робота возвращаются клиенту с учетом типа контента
   - Отдельная обработка потоковых данных и изображений

4. **Обработка ошибок**:
   - Таймауты запросов обрабатываются и возвращают 504 Gateway Timeout
   - Ошибки соединения возвращают 502 Bad Gateway
   - Ошибки доступа к сущностям возвращают 404 Not Found
   - Детальное логирование для диагностики проблем

## Пользовательский интерфейс

### Lovelace карточка

1. **Статическое отображение**:
   - Статус онлайн/оффлайн с цветовой индикацией
   - IP-адрес робота
   - Кнопка управления с иконкой джойстика (активна только если робот онлайн)

2. **Реализация с LitElement**:
   - Использует стандартные компоненты Home Assistant (ha-card, mwc-button)
   - Стили соответствуют теме Home Assistant с использованием CSS-переменных
   - Реактивное обновление при изменении состояния сенсора

### Интерфейс управления

1. **Нативный попап**:
   - Создается с помощью HTML5 Dialog API
   - Современный адаптивный дизайн с использованием CSS Grid и Flexbox
   - Соответствует дизайну Home Assistant (использует CSS-переменные)
   - Поддержка темной и светлой тем
   - Кнопка закрытия в правом верхнем углу
   - Полностью интегрирован в Home Assistant без использования iframe

2. **Видеопоток**:
   - Отображается с помощью элемента `<img>` с динамическим обновлением
   - Использует Blob API и createObjectURL для работы с потоковыми данными
   - Запрос проходит через прокси-API с использованием fetchWithAuth для авторизации
   - Отображение статуса загрузки и ошибок
   - Управление потоком через кнопку Start/Stop с визуальной индикацией

3. **Джойстик управления**:
   - Интерактивный элемент для управления движением
   - Поддержка как мыши, так и сенсорного экрана
   - Нормализация координат в диапазон -1 до 1 с плавающей точкой
   - Отправка команд управления через прокси-API c авторизацией
   - Визуальная обратная связь при перемещении
   - Обработка граничных условий для ограничения движения
   - Дросселирование запросов для оптимизации производительности (10 запросов в секунду)

4. **Обновление статуса**:
   - Периодический опрос эндпоинта `/status` через прокси с авторизацией
   - Отображение актуального FPS с одним знаком после запятой (формат X.X)
   - Обработка ошибок соединения и автоматическая реконнект
   - Интервальные обновления с оптимальной частотой для снижения нагрузки

5. **Панель настроек**:
   - Выдвижная панель с левой стороны экрана
   - Выбор разрешения камеры из списка предустановленных опций
   - Ползунок настройки качества изображения (8-64) с визуальной обратной связью
   - Ползунок управления яркостью LED (0-100%) с визуальной обратной связью
   - Асинхронное получение и применение настроек
   - Дросселирование запросов при перетаскивании ползунков для оптимизации производительности

## Безопасность

1. **Аутентификация**:
   - Все запросы к роботу проходят через Home Assistant и требуют авторизации
   - Используется встроенная система аутентификации Home Assistant
   - Поддержка авторизации через подписанные URL (signed URLs) с помощью WebSocket API
   - Прямой доступ к роботу из внешней сети не требуется

2. **Безопасность видеопотока**:
   - MJPEG-стрим защищен аутентификацией Home Assistant
   - Используются подписанные URL (signed URLs) с помощью WebSocket API `auth/sign_path`
   - Поддержка authSig токенов для доступа к стриму в контекстах, где обычная аутентификация недоступна (например, в `<img>` тегах)
   - Проверка аутентификации при начале стрима

3. **Изоляция данных**:
   - Компонент не хранит чувствительных данных
   - IP-адрес хранится локально в конфигурации Home Assistant
   - Токены доступа не передаются роботу

4. **Валидация**:
   - Все входные данные проверяются
   - Используются схемы валидации (voluptuous)
   - Защита от инъекций в API-запросах
   - Санитизация параметров запросов

## Производительность

1. **Асинхронные операции**:
   - Все HTTP-запросы выполняются асинхронно
   - Статические ресурсы регистрируются через асинхронные методы
   - Избегаем блокирующих I/O операций в event loop
   - Обработка MJPEG стрима оптимизирована для длительной работы

2. **Оптимизация Lovelace**:
   - Компактный JavaScript-код
   - Эффективное обновление UI через LitElement
   - Минимальная нагрузка на браузер
   - Ленивая загрузка видеопотока

3. **Оптимизация видеопотока**:
   - Использование WebSocket API для получения signed URL для доступа к стриму
   - Правильное кэширование и буферизация потока данных
   - Обработка ошибок загрузки изображений
   - Возможность остановки/запуска потока для экономии ресурсов
   - Настройка размера буфера для оптимальной производительности

4. **Оптимизация управления**:
   - Дросселирование команд джойстика для снижения нагрузки на сеть
   - Округление значений координат до 2 знаков после запятой
   - Отправка команд только при значительном изменении положения
   - Отложенная отправка команд для снижения нагрузки

## Расширяемость

1. **Модульная структура**:
   - Каждый компонент независим
   - Отделение UI от логики
   - Легко добавлять новые функции
   - Простое тестирование

2. **Конфигурация**:
   - Гибкие настройки через config flow
   - Поддержка разных роботов
   - Настраиваемый интервал обновления
   - Расширяемый формат данных

## Последовательность работы

1. **Установка и настройка**:
   - Добавление компонента в custom_components 
   - Настройка через UI с указанием IP адреса робота
   - Регистрация JS ресурсов для Lovelace
   - Создание сущностей-сенсоров

2. **Добавление карточки**:
   - Добавление ESP32 Robot Card на Lovelace dashboard
   - Автоматический выбор доступного сенсора
   - Отображение состояния робота и метрик

3. **Использование**:
   - Мониторинг статуса через карточку
   - Открытие интерфейса управления через кнопку
   - Управление роботом через джойстик
   - Просмотр видеопотока с авторизованным доступом
   - Настройка качества изображения и LED-подсветки

## Взаимодействие с роботом

1. **HTTP API робота**:
   - Робот предоставляет свой HTTP API на порту 80
   - Основные эндпоинты: `/status`, `/stream`, `/control`, `/quality`, `/led`
   - JSON-формат для обмена данными
   - Поддержка потоковой передачи изображений

2. **Проксирование через Home Assistant**:
   - Все запросы к роботу проходят через прокси компонента
   - Прокси обеспечивает аутентификацию и безопасность через встроенные механизмы HA
   - Встроенная поддержка аутентификации через подписанные URL (signed URLs)
   - Надежное определение сущностей и их состояний
   - Поддержка всех методов HTTP (GET, POST)
   - Прямые эндпоинты: `/api/esp32_robot/proxy/{sensor_id}/{path}`
   - Корректная передача заголовков для обоих методов HTTP

3. **Защищенный доступ к видеопотоку**:
   - Генерация подписанных URL для доступа к стриму через WebSocket API
   - Использование `auth/sign_path` для генерации аутентификационных токенов
   - Безопасное отображение стрима в UI без необходимости прямого доступа к роботу
   - Поддержка длительных соединений для MJPEG стрима без таймаутов