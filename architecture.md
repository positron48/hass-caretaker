# Архитектура ESP32 Robot для Home Assistant

## Общее описание

ESP32 Robot - это компонент для Home Assistant, который позволяет управлять ESP32-роботом через веб-интерфейс. Компонент реализует прокси-сервер для безопасного доступа к веб-интерфейсу робота через Home Assistant.

## Структура файлов

### Основные файлы

#### `custom_components/esp32_robot/__init__.py`
- Точка входа компонента
- Инициализация компонента
- Регистрация сервисов и сенсоров
- Управление жизненным циклом компонента

#### `custom_components/esp32_robot/manifest.json`
- Метаданные компонента
- Зависимости
- Версия
- Требования к системе

#### `custom_components/esp32_robot/config_flow.py`
- Конфигурация компонента через UI Home Assistant
- Валидация введенных данных
- Создание и обновление конфигурации

#### `custom_components/esp32_robot/const.py`
- Константы компонента
- Настройки по умолчанию
- Схемы валидации

#### `custom_components/esp32_robot/services.yaml`
- Описание сервисов компонента
- Параметры сервисов
- Примеры использования

### Прокси-сервер

#### `custom_components/esp32_robot/proxy.py`
- Реализация прокси-сервера
- Токен-аутентификация через Home Assistant
- Обработка HTTP-запросов
- Переписывание URL
- Поддержка WebSocket
- Обработка потокового видео
- Декомпрессия контента
- Многоуровневая обработка ошибок
- Оптимизация для больших HTML-страниц
- Безопасность и аутентификация

### Сенсоры

#### `custom_components/esp32_robot/sensors.py`
- Реализация сенсоров для мониторинга состояния робота
- Сбор метрик
- Обновление данных
- Предоставление URL для iframe с поддержкой токенов

### Сервисы

#### `custom_components/esp32_robot/services.py`
- Реализация сервисов для управления роботом
- Обработка команд
- Взаимодействие с API робота

### Lovelace UI

#### `www/community/esp32-robot-card/esp32-robot-card.js`
- Пользовательский интерфейс для Lovelace
- Отображение состояния робота
- Управление роботом через UI
- Встроенный iframe для веб-интерфейса робота
- Автоматическое добавление токена в URL iframe

### Документация

#### `README.md`
- Основная документация проекта
- Инструкции по установке
- Примеры использования
- Описание функциональности

#### `architecture.md`
- Документация по архитектуре
- Описание структуры проекта
- Взаимодействие компонентов

## Взаимодействие компонентов

1. **Инициализация**:
   - Home Assistant загружает компонент через `custom_components/esp32_robot/__init__.py`
   - Регистрируются все необходимые сервисы и сенсоры
   - Инициализируется прокси-сервер

2. **Конфигурация**:
   - Пользователь настраивает компонент через UI
   - `custom_components/esp32_robot/config_flow.py` валидирует и сохраняет настройки
   - Настройки используются для инициализации компонентов

3. **Проксирование запросов**:
   - Запросы к роботу проходят через прокси-сервер
   - `custom_components/esp32_robot/proxy.py` проверяет токен и аутентифицирует пользователя
   - HTML-контент модифицируется для корректной работы через прокси
   - Обеспечивается безопасный доступ к роботу

4. **Мониторинг**:
   - Сенсоры собирают данные о состоянии робота
   - Данные отображаются в Home Assistant
   - Обновления происходят в реальном времени

5. **Управление**:
   - Сервисы предоставляют API для управления роботом
   - Команды отправляются через прокси-сервер
   - Результаты отображаются в UI

6. **Пользовательский интерфейс**:
   - Lovelace карточка отображает состояние робота
   - Встроенный iframe показывает веб-интерфейс робота с токеном аутентификации
   - UI обновляется в реальном времени

## Детали прокси-сервера

### Токен-аутентификация

1. **Lovelace карточка**:
   - Получает токен из `this.hass.auth.data.access_token`
   - Добавляет токен к URL при открытии iframe
   - Передает токен как query-параметр: `/api/esp32_robot_proxy/robot_id/?token=xxx`

2. **Проверка на сервере**:
   - Прокси-сервер работает с `requires_auth=False` (для совместимости с iframe)
   - Самостоятельно проверяет токен через `async_get_user_from_request()`
   - Если токен валидный, выполняет проксирование запроса
   - Если токен невалидный, возвращает ошибку 401 Unauthorized

3. **Безопасность**:
   - Токен удаляется из запроса к роботу
   - Проверка происходит на стороне Home Assistant
   - Поддерживается работа из внешних сетей

### Типы обрабатываемого контента

1. **HTML-контент**:
   - Чтение контента по частям с большим буфером (1 МБ)
   - Интеллектуальное определение кодировки из заголовков
   - Модификация URL для работы через прокси
   - Вставка JavaScript для перехвата динамических запросов
   - Многоуровневая обработка ошибок с резервными методами

2. **API-контент (JSON, XML)**:
   - Передача без модификации URL
   - Корректная обработка кодировок
   - Предотвращение ошибок декодирования

3. **Потоковый контент**:
   - Поддержка потокового видео
   - Бесконечный таймаут для непрерывных потоков
   - Оптимизированная передача данных чанками
   - Обработка прерывания потока

4. **Бинарный контент**:
   - Эффективная передача больших файлов
   - Сохранение правильных заголовков
   - Оптимизация размера буфера

### Механизмы безопасности

1. **Аутентификация**:
   - Использование токенов доступа Home Assistant
   - Проверка токенов в query-параметрах
   - Поддержка cookie-аутентификации

2. **Обработка прокси-путей**:
   - Безопасное переписывание URL
   - Изоляция запросов к роботу
   - Поддержка WebSocket через WSS

3. **Обработка контента**:
   - Декомпрессия gzip-контента
   - Удаление заголовков Content-Encoding
   - Предотвращение ошибок декодирования

### Обработка ошибок

1. **Многоуровневая защита**:
   - Первичная обработка стандартным способом
   - Вторичная обработка через Response
   - Резервная обработка через StreamResponse
   - Подробное логирование ошибок

2. **Проверки целостности**:
   - Проверка размера модифицированного контента
   - Автоматический возврат к оригиналу при проблемах
   - Фоллбэк-механизмы для различных типов контента

## Безопасность

1. **Аутентификация**:
   - Токен-аутентификация через Home Assistant
   - Используется встроенная система аутентификации
   - Поддерживается OAuth и токены

2. **Проксирование**:
   - Запросы к роботу изолированы
   - URL переписываются для безопасности
   - Поддерживается HTTPS

3. **Валидация**:
   - Все входные данные проверяются
   - Используются схемы валидации
   - Защита от инъекций

## Расширяемость

1. **Модульная структура**:
   - Каждый компонент независим
   - Легко добавлять новые функции
   - Простое тестирование

2. **API**:
   - Четко определенные интерфейсы
   - Документированные сервисы
   - Поддержка событий

3. **Конфигурация**:
   - Гибкие настройки
   - Поддержка разных роботов
   - Легкое обновление