# Архитектура ESP32 Robot для Home Assistant

## Общее описание

ESP32 Robot - это компонент для Home Assistant, который позволяет мониторить статус ESP32-роботов через пользовательский интерфейс Lovelace.

## Структура файлов

### Основные файлы

#### `custom_components/esp32_robot/__init__.py`
- Точка входа компонента
- Инициализация компонента и frontend
- Регистрация сенсоров
- Управление жизненным циклом компонента

#### `custom_components/esp32_robot/manifest.json`
- Метаданные компонента
- Зависимости
- Версия
- Требования к системе

#### `custom_components/esp32_robot/config_flow.py`
- Конфигурация компонента через UI Home Assistant
- Валидация введенных данных
- Создание и обновление конфигурации

#### `custom_components/esp32_robot/const.py`
- Константы компонента
- Настройки по умолчанию
- Схемы валидации

### Сенсоры

#### `custom_components/esp32_robot/sensor.py`
- Реализация сенсоров для мониторинга состояния робота
- Запрос `/status` на роботе для проверки его состояния
- Сбор метрик (fps, streaming)
- Обновление данных
- Интеллектуальная обработка ошибок

### Lovelace UI

#### `custom_components/esp32_robot/frontend.py`
- Регистрация ресурсов JavaScript для Lovelace
- Асинхронная регистрация статических путей
- Предотвращение блокирующих I/O операций в event loop

#### `custom_components/esp32_robot/lovelace/esp32-robot-card.js`
- Пользовательский интерфейс для Lovelace
- Отображение статуса робота (онлайн/оффлайн)
- Отображение информации о стриминге и FPS
- Скрытие сообщений об ошибках, когда робот оффлайн

#### `custom_components/esp32_robot/lovelace/editor.js`
- Конфигуратор карточки для Lovelace
- Выбор сенсора для отображения
- Настройка заголовка карточки

### Документация

#### `custom_components/esp32_robot/README.md`
- Основная документация проекта
- Инструкции по установке
- Примеры использования
- Описание функциональности

#### `architecture.md`
- Документация по архитектуре
- Описание структуры проекта
- Взаимодействие компонентов

## Взаимодействие компонентов

1. **Инициализация**:
   - Home Assistant загружает компонент через `custom_components/esp32_robot/__init__.py`
   - Регистрируются необходимые сенсоры
   - Настраивается frontend для Lovelace

2. **Конфигурация**:
   - Пользователь настраивает компонент через UI
   - `custom_components/esp32_robot/config_flow.py` валидирует и сохраняет настройки
   - Настройки используются для инициализации компонентов

3. **Мониторинг**:
   - Сенсор периодически запрашивает эндпоинт `/status` на роботе
   - Данные о статусе, FPS и стриминге передаются в Home Assistant
   - Сенсор интеллектуально обрабатывает ошибки и определяет статус робота

4. **Пользовательский интерфейс**:
   - Lovelace карточка отображает статус робота
   - Информация о стриминге и FPS отображается, если робот онлайн
   - Сообщения об ошибках скрываются, когда робот оффлайн
   - UI обновляется в реальном времени

## Детали сенсора

### Проверка статуса

1. **Эндпоинт `/status`**:
   - Запрос JSON-данных о статусе робота
   - Парсинг информации о fps и streaming
   - Определение статуса "online" или "offline"

2. **Обработка ошибок**:
   - Таймауты и ошибки соединения считаются как "offline"
   - Невалидный JSON считается как "offline"
   - Ошибки HTTP считаются как "offline"
   - Информация об ошибках сохраняется, но отображается только если робот онлайн

### Атрибуты сенсора

1. **Основные атрибуты**:
   - `ip_address`: IP-адрес робота
   - `direct_url`: Прямой URL для доступа к интерфейсу робота

2. **Статус-зависимые атрибуты**:
   - `fps`: Текущий FPS камеры (если робот онлайн и стримит)
   - `streaming`: Статус стриминга (если робот онлайн)
   - `last_error`: Информация о последней ошибке (только если робот онлайн)

## Lovelace карточка

1. **Отображение статуса**:
   - Иконка робота: зеленая для "online", красная для "offline"
   - Текстовый статус: "онлайн" или "оффлайн"

2. **Дополнительная информация**:
   - IP-адрес робота
   - Статус стриминга (только если робот онлайн)
   - FPS (только если робот онлайн и стримит)
   - Сообщения об ошибках (только если робот онлайн)

3. **Интеллектуальное отображение**:
   - Скрытие сообщений об ошибках, когда робот оффлайн
   - Динамическое отображение информации в зависимости от статуса

## Безопасность

1. **Изоляция данных**:
   - Компонент не хранит чувствительных данных
   - IP-адрес хранится локально в конфигурации Home Assistant

2. **Валидация**:
   - Все входные данные проверяются
   - Используются схемы валидации
   - Защита от инъекций

## Производительность

1. **Асинхронные операции**:
   - Все HTTP-запросы выполняются асинхронно
   - Статические ресурсы регистрируются через асинхронные методы
   - Блокирующие I/O операции отсутствуют в event loop

2. **Оптимизация Lovelace**:
   - Компактный JavaScript-код
   - Эффективное обновление UI
   - Минимальная нагрузка на браузер

## Расширяемость

1. **Модульная структура**:
   - Каждый компонент независим
   - Легко добавлять новые функции
   - Простое тестирование

2. **Конфигурация**:
   - Гибкие настройки
   - Поддержка разных роботов
   - Настраиваемый интервал обновления